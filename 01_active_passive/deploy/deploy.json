{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "name": {
            "type": "string",
            "allowedValues": [],
            "metadata": {
                "description": ""
            }
        },
        "VM Username": {
            "type": "string",
            "defaultValue": "admin123",
            "metadata": {
                "description": ""
            }
        },
        "VM Password": {
            "type": "securestring",
            "metadata": {
                "description": ""
            }
        },
        "Resource Group West": {
            "type": "string",
            "defaultValue": "[replace(resourceGroup().name, 'east', 'west')]",
            "metadata": {
                "description": ""
            }
        }
    },
    "variables": {
        "baseUrl": "[deployment().properties.templateLink.uri]",
        "rando": "[uniqueString(resourceGroup().id, parameters('name'))]",
        "baseName": "[concat(parameters('name'), '-', variables('rando'))]",
        "baseNameSafe": "[concat(substring(toLower(replace(variables('baseName'),'-', '')), 0, 8),variables('rando'))]",
        "rgEast": "[resourceGroup().name]",
        "rgWest": "[parameters('Resource Group West')]",
        "vnetSettingsEast": {
            "name": "[concat(variables('baseName'), '-vnet-east')]",
            "addressSpace": {
                "addressPrefixes": ["10.0.0.0/16"]
            },
            "subnets": [
                {
                    "name": "aks",
                    "properties": {
                        "addressPrefix": "10.0.2.0/24",
                        "serviceEndpoints": [],
                        "delegations": [],
                        "privateEndpointNetworkPolicies": "Enabled",
                        "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                },
                {
                    "name": "admin",
                    "properties": {
                        "addressPrefix": "10.0.3.0/24",
                        "serviceEndpoints": [],
                        "privateEndpointNetworkPolicies": "Enabled",
                        "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                }
            ]
        },
        "vnetSettingsWest": {
            "name": "[concat(variables('baseName'), '-vnet-west')]",
            "addressSpace": {
                "addressPrefixes": ["10.1.0.0/16"]
            },
            "subnets": [
                {
                    "name": "aks",
                    "properties": {
                        "addressPrefix": "10.1.2.0/24",
                        "serviceEndpoints": [],
                        "delegations": [],
                        "privateEndpointNetworkPolicies": "Enabled",
                        "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                },
                {
                    "name": "admin",
                    "properties": {
                        "addressPrefix": "10.1.3.0/24",
                        "serviceEndpoints": [],
                        "privateEndpointNetworkPolicies": "Enabled",
                        "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                }
            ]
        },
        "postgresSettings": {
            "eastName": "[concat(variables('baseName'), '-psql-east')]",
            "westName": "[concat(variables('baseName'), '-psql-west')]",
            "username": "[parameters('VM Username')]",
            "password": "[parameters('VM Password')]",
            "rgEast": "[variables('rgEast')]",
            "rgWest": "[variables('rgWest')]"
        },
        "aksSettings": {
            "name": "[concat(variables('baseName'), '-aks')]"
        },
        "trafficManagerSettings": {
            "name": "[concat(variables('baseName'), '-tm')]"
        },
        "vmSettings": {
            "name": "[concat(variables('baseName'), '-vm')]"
        }
    },
    "resources": [
        {
            "name": "vnet-east",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-01-01",
            "resourceGroup": "[variables('rgEast')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('baseUrl'),'vnet/deploy.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VnetSettings": {
                        "value": "[variables('vnetSettingsEast')]"
                    }
                }
            }
        },
        {
            "name": "vnet-west",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-01-01",
            "resourceGroup": "[variables('rgWest')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('baseUrl'),'vnet/deploy.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VnetSettings": {
                        "value": "[variables('vnetSettingsWest')]"
                    }
                }
            }
        },
        {
            "name": "psql",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(variables('baseUrl'),'postgres/deploy.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PostgresSettings": {
                        "value": "[variables('postgresSettings')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "Postgres East": {
            "type": "string",
            "value": "[reference('psql').outputs.psql_east.value]"
        },
        "Postgres West": {
            "type": "string",
            "value": "[reference('psql').outputs.psql_west.value]"
        }
    }
  }